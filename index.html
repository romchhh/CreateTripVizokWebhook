<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–î–æ–¥–∞—Ç–∏ –º–∞—Ä—à—Ä—É—Ç –ø–æ—ó–∑–¥–∫–∏</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            padding: 20px;
            min-height: 100vh;
        }
        
        .container {
            max-width: 400px;
            margin: 0 auto;
        }
        
        .header {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .header h1 {
            font-size: 24px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .header p {
            font-size: 16px;
            color: var(--tg-theme-hint-color, #999999);
            line-height: 1.4;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .city-input {
            width: 100%;
            padding: 15px;
            border: 2px solid var(--tg-theme-button-color, #0088cc);
            border-radius: 12px;
            font-size: 16px;
            font-family: inherit;
            background: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
            transition: border-color 0.3s ease;
            margin-bottom: 10px;
        }
        
        .city-input:focus {
            outline: none;
            border-color: var(--tg-theme-button-color, #0088cc);
            box-shadow: 0 0 0 3px rgba(0, 136, 204, 0.1);
        }
        
        .city-input::placeholder {
            color: var(--tg-theme-hint-color, #999999);
        }
        
        .stops-container {
            margin-bottom: 20px;
        }
        
        .stop-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 15px;
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 12px;
            border: 1px solid #e0e0e0;
        }
        
        .stop-number {
            background: var(--tg-theme-button-color, #0088cc);
            color: white;
            width: 30px;
            height: 30px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 14px;
            margin-right: 15px;
            flex-shrink: 0;
        }
        
        .stop-content {
            flex: 1;
        }
        
        .stop-name {
            font-weight: 600;
            font-size: 16px;
            color: var(--tg-theme-text-color, #000000);
            margin-bottom: 5px;
        }
        
        .stop-country {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
        }
        
        .remove-stop {
            background: #ff4444;
            color: white;
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            cursor: pointer;
            font-size: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-left: 10px;
        }
        
        .remove-stop:hover {
            background: #cc0000;
        }
        
        .add-stop-container {
            position: relative;
        }
        
        .add-stop-btn {
            width: 100%;
            padding: 15px;
            background: transparent;
            color: var(--tg-theme-button-color, #0088cc);
            border: 2px dashed var(--tg-theme-button-color, #0088cc);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }
        
        .add-stop-btn:hover {
            background: var(--tg-theme-button-color, #0088cc);
            color: white;
        }
        
        /* –°—Ç–∏–ª—ñ –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫ –º—ñ—Å—Ç */
        .suggestions-container {
            /* –°—Ç–∏–ª—ñ –¥–æ–¥–∞—é—Ç—å—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ –≤ JavaScript */
        }
        
        .example {
            background: var(--tg-theme-secondary-bg-color, #f8f9fa);
            border-radius: 8px;
            padding: 15px;
            margin-top: 10px;
            border-left: 4px solid var(--tg-theme-button-color, #0088cc);
        }
        
        .example h3 {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--tg-theme-text-color, #000000);
        }
        
        .example p {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #666666);
            line-height: 1.4;
        }
        
        .city-count {
            font-size: 14px;
            color: var(--tg-theme-hint-color, #999999);
            margin-top: 5px;
        }
        
        .submit-btn {
            width: 100%;
            padding: 15px;
            background: var(--tg-theme-button-color, #0088cc);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 20px;
        }
        
        .submit-btn:hover {
            opacity: 0.9;
            transform: translateY(-1px);
        }
        
        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .error {
            color: #ff3333;
            font-size: 14px;
            margin-top: 5px;
            display: none;
        }
        
        .success {
            background: #4CAF50;
            color: white;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
            margin-top: 20px;
            display: none;
        }
        
        @media (max-width: 480px) {
            body {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 20px;
            }
            
            .cities-input {
                min-height: 150px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1 id="pageTitle">üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –ø–æ—ó–∑–¥–∫–∏</h1>
            <p id="pageDescription">–î–æ–¥–∞–π—Ç–µ –º—ñ—Å—Ç–∞ –≤–∞—à–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É</p>
        </div>
        
        <form id="routeForm">
            <!-- –°–ø–∏—Å–æ–∫ –∑—É–ø–∏–Ω–æ–∫ -->
            <div class="stops-container" id="stopsContainer">
                <!-- –ó—É–ø–∏–Ω–∫–∏ –±—É–¥—É—Ç—å –¥–æ–¥–∞–≤–∞—Ç–∏—Å—è –¥–∏–Ω–∞–º—ñ—á–Ω–æ -->
            </div>
            
            <!-- –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–æ–≤–æ—ó –∑—É–ø–∏–Ω–∫–∏ -->
            <div class="add-stop-container" id="addStopContainer" style="display: none;">
                <div class="form-group">
                    <label for="cityInput" id="addStopLabel">–î–æ–¥–∞—Ç–∏ –∑—É–ø–∏–Ω–∫—É:</label>
                    <input 
                        type="text" 
                        id="cityInput" 
                        class="city-input" 
                        placeholder="–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞..."
                        autocomplete="off"
                    />
                </div>
            </div>
            
            <!-- –ö–Ω–æ–ø–∫–∞ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –ø–µ—Ä—à–æ—ó –∑—É–ø–∏–Ω–∫–∏ -->
            <button type="button" class="add-stop-btn" id="addStopBtn">
                ‚ûï –î–æ–¥–∞—Ç–∏ –∑—É–ø–∏–Ω–∫—É
            </button>
            
            <div class="city-count" id="cityCount">–ó—É–ø–∏–Ω–æ–∫: 0</div>
            <div class="error" id="error">–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 2 –∑—É–ø–∏–Ω–∫–∏</div>
            
            <div class="example" id="exampleBlock">
                <h3 id="exampleTitle">üí° –ü—Ä–∏–∫–ª–∞–¥ –º–∞—Ä—à—Ä—É—Ç—É:</h3>
                <p id="exampleText">–ö–∏—ó–≤ ‚Üí –ñ–∏—Ç–æ–º–∏—Ä ‚Üí –†—ñ–≤–Ω–µ ‚Üí –õ—å–≤—ñ–≤</p>
            </div>
            
            <button type="submit" class="submit-btn" id="submitBtn" disabled>
                ‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç
            </button>
            
            <div class="success" id="success">
                ‚úÖ –ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!
            </div>
        </form>
    </div>

    <script>
        // –ß–µ–∫–∞—î–º–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DOM
        document.addEventListener('DOMContentLoaded', function() {
            // –Ü–Ω—ñ—Ü—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è Telegram WebApp
            let tg = window.Telegram.WebApp;
            tg.expand();
        
        // –û—Ç—Ä–∏–º—É—î–º–æ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ –∑ URL
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id') || tg.initDataUnsafe?.user?.id || 'unknown';
        const userLang = urlParams.get('lang') || 'uk';
        const actionType = urlParams.get('create') || 'trip';
        const webhookUrl = urlParams.get('webhook_url') || 'http://194.104.23.37:8001/webhook';
        
        // –ü–µ—Ä–µ–∫–ª–∞–¥–∏ –¥–ª—è –≤—Å—ñ—Ö –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞–Ω–∏—Ö –º–æ–≤
        const translations = {
            uk: {
                pageTitle: 'üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –ø–æ—ó–∑–¥–∫–∏',
                pageDescription: '–î–æ–¥–∞–π—Ç–µ –º—ñ—Å—Ç–∞ –≤–∞—à–æ–≥–æ –º–∞—Ä—à—Ä—É—Ç—É –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º—É –ø–æ—Ä—è–¥–∫—É',
                addStopLabel: '–î–æ–¥–∞—Ç–∏ –∑—É–ø–∏–Ω–∫—É:',
                addStopBtn: '‚ûï –î–æ–¥–∞—Ç–∏ –∑—É–ø–∏–Ω–∫—É',
                cityPlaceholder: '–ü–æ—á–Ω—ñ—Ç—å –≤–≤–æ–¥–∏—Ç–∏ –Ω–∞–∑–≤—É –º—ñ—Å—Ç–∞...',
                stopsCount: '–ó—É–ø–∏–Ω–æ–∫',
                errorMessage: '–ë—É–¥—å –ª–∞—Å–∫–∞, –¥–æ–¥–∞–π—Ç–µ –ø—Ä–∏–Ω–∞–π–º–Ω—ñ 2 –∑—É–ø–∏–Ω–∫–∏',
                exampleTitle: 'üí° –ü—Ä–∏–∫–ª–∞–¥ –º–∞—Ä—à—Ä—É—Ç—É:',
                exampleText: '–ö–∏—ó–≤ ‚Üí –ñ–∏—Ç–æ–º–∏—Ä ‚Üí –†—ñ–≤–Ω–µ ‚Üí –õ—å–≤—ñ–≤',
                confirmBtn: '‚úÖ –ü—ñ–¥—Ç–≤–µ—Ä–¥–∏—Ç–∏ –º–∞—Ä—à—Ä—É—Ç',
                savingBtn: '‚è≥ –ó–±–µ—Ä–µ–∂–µ–Ω–Ω—è...',
                successMessage: '‚úÖ –ú–∞—Ä—à—Ä—É—Ç —É—Å–ø—ñ—à–Ω–æ –∑–±–µ—Ä–µ–∂–µ–Ω–æ!',
                errorSaving: '–ü–æ–º–∏–ª–∫–∞ –ø—Ä–∏ –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—ñ –º–∞—Ä—à—Ä—É—Ç—É. –°–ø—Ä–æ–±—É–π—Ç–µ —â–µ —Ä–∞–∑.',
                addManually: '‚ûï –î–æ–¥–∞—Ç–∏ "{query}" –≤—Ä—É—á–Ω—É',
                addManuallyDesc: '–ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ü–µ –º—ñ—Å—Ç–æ –¥–æ –º–∞—Ä—à—Ä—É—Ç—É',
                ownCity: '–í–ª–∞—Å–Ω–µ –º—ñ—Å—Ç–æ',
                unknownCountry: '–ù–µ–≤—ñ–¥–æ–º–∞ –∫—Ä–∞—ó–Ω–∞'
            },
            pl: {
                pageTitle: 'üó∫Ô∏è Trasa podr√≥≈ºy',
                pageDescription: 'Dodaj miasta do swojej trasy we w≈Ça≈õciwej kolejno≈õci',
                addStopLabel: 'Dodaj przystanek:',
                addStopBtn: '‚ûï Dodaj przystanek',
                cityPlaceholder: 'Zacznij wpisywaƒá nazwƒô miasta...',
                stopsCount: 'Przystank√≥w',
                errorMessage: 'Proszƒô dodaƒá co najmniej 2 przystanki',
                exampleTitle: 'üí° Przyk≈Çad trasy:',
                exampleText: 'Warszawa ‚Üí Krak√≥w ‚Üí Wroc≈Çaw ‚Üí Gda≈Ñsk',
                confirmBtn: '‚úÖ Potwierd≈∫ trasƒô',
                savingBtn: '‚è≥ Zapisywanie...',
                successMessage: '‚úÖ Trasa zosta≈Ça pomy≈õlnie zapisana!',
                errorSaving: 'B≈ÇƒÖd podczas zapisywania trasy. Spr√≥buj ponownie.',
                addManually: '‚ûï Dodaj "{query}" rƒôcznie',
                addManuallyDesc: 'Kliknij, aby dodaƒá to miasto do trasy',
                ownCity: 'W≈Çasne miasto',
                unknownCountry: 'Nieznany kraj'
            },
            en: {
                pageTitle: 'üó∫Ô∏è Trip Route',
                pageDescription: 'Add cities to your route in the correct order',
                addStopLabel: 'Add stop:',
                addStopBtn: '‚ûï Add stop',
                cityPlaceholder: 'Start typing city name...',
                stopsCount: 'Stops',
                errorMessage: 'Please add at least 2 stops',
                exampleTitle: 'üí° Route example:',
                exampleText: 'London ‚Üí Manchester ‚Üí Liverpool ‚Üí Edinburgh',
                confirmBtn: '‚úÖ Confirm route',
                savingBtn: '‚è≥ Saving...',
                successMessage: '‚úÖ Route saved successfully!',
                errorSaving: 'Error saving route. Please try again.',
                addManually: '‚ûï Add "{query}" manually',
                addManuallyDesc: 'Click to add this city to the route',
                ownCity: 'Custom city',
                unknownCountry: 'Unknown country'
            },
            de: {
                pageTitle: 'üó∫Ô∏è Reiseroute',
                pageDescription: 'F√ºgen Sie St√§dte zu Ihrer Route in der richtigen Reihenfolge hinzu',
                addStopLabel: 'Stopp hinzuf√ºgen:',
                addStopBtn: '‚ûï Stopp hinzuf√ºgen',
                cityPlaceholder: 'Beginnen Sie mit der Eingabe des Stadtnamens...',
                stopsCount: 'Stopps',
                errorMessage: 'Bitte f√ºgen Sie mindestens 2 Stopps hinzu',
                exampleTitle: 'üí° Routenbeispiel:',
                exampleText: 'Berlin ‚Üí Hamburg ‚Üí M√ºnchen ‚Üí K√∂ln',
                confirmBtn: '‚úÖ Route best√§tigen',
                savingBtn: '‚è≥ Speichern...',
                successMessage: '‚úÖ Route erfolgreich gespeichert!',
                errorSaving: 'Fehler beim Speichern der Route. Bitte versuchen Sie es erneut.',
                addManually: '‚ûï "{query}" manuell hinzuf√ºgen',
                addManuallyDesc: 'Klicken Sie, um diese Stadt zur Route hinzuzuf√ºgen',
                ownCity: 'Eigene Stadt',
                unknownCountry: 'Unbekanntes Land'
            },
            cs: {
                pageTitle: 'üó∫Ô∏è Trasa cesty',
                pageDescription: 'P≈ôidejte mƒõsta do sv√© trasy ve spr√°vn√©m po≈ôad√≠',
                addStopLabel: 'P≈ôidat zast√°vku:',
                addStopBtn: '‚ûï P≈ôidat zast√°vku',
                cityPlaceholder: 'Zaƒçnƒõte ps√°t n√°zev mƒõsta...',
                stopsCount: 'Zast√°vek',
                errorMessage: 'Pros√≠m p≈ôidejte alespo≈à 2 zast√°vky',
                exampleTitle: 'üí° P≈ô√≠klad trasy:',
                exampleText: 'Praha ‚Üí Brno ‚Üí Ostrava ‚Üí Plze≈à',
                confirmBtn: '‚úÖ Potvrdit trasu',
                savingBtn: '‚è≥ Ukl√°d√°n√≠...',
                successMessage: '‚úÖ Trasa byla √∫spƒõ≈°nƒõ ulo≈æena!',
                errorSaving: 'Chyba p≈ôi ukl√°d√°n√≠ trasy. Zkuste to znovu.',
                addManually: '‚ûï P≈ôidat "{query}" ruƒçnƒõ',
                addManuallyDesc: 'Kliknƒõte pro p≈ôid√°n√≠ tohoto mƒõsta do trasy',
                ownCity: 'Vlastn√≠ mƒõsto',
                unknownCountry: 'Nezn√°m√° zemƒõ'
            },
            bg: {
                pageTitle: 'üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –Ω–∞ –ø—ä—Ç—É–≤–∞–Ω–µ—Ç–æ',
                pageDescription: '–î–æ–±–∞–≤–µ—Ç–µ –≥—Ä–∞–¥–æ–≤–µ –∫—ä–º –≤–∞—à–∏—è –º–∞—Ä—à—Ä—É—Ç –≤ –ø—Ä–∞–≤–∏–ª–Ω–∏—è —Ä–µ–¥',
                addStopLabel: '–î–æ–±–∞–≤–∏ —Å–ø–∏—Ä–∫–∞:',
                addStopBtn: '‚ûï –î–æ–±–∞–≤–∏ —Å–ø–∏—Ä–∫–∞',
                cityPlaceholder: '–ó–∞–ø–æ—á–Ω–µ—Ç–µ –¥–∞ –≤—ä–≤–µ–∂–¥–∞—Ç–µ –∏–º–µ –Ω–∞ –≥—Ä–∞–¥...',
                stopsCount: '–°–ø–∏—Ä–∫–∏',
                errorMessage: '–ú–æ–ª—è, –¥–æ–±–∞–≤–µ—Ç–µ –ø–æ–Ω–µ 2 —Å–ø–∏—Ä–∫–∏',
                exampleTitle: 'üí° –ü—Ä–∏–º–µ—Ä –∑–∞ –º–∞—Ä—à—Ä—É—Ç:',
                exampleText: '–°–æ—Ñ–∏—è ‚Üí –ü–ª–æ–≤–¥–∏–≤ ‚Üí –í–∞—Ä–Ω–∞ ‚Üí –ë—É—Ä–≥–∞—Å',
                confirmBtn: '‚úÖ –ü–æ—Ç–≤—ä—Ä–¥–∏ –º–∞—Ä—à—Ä—É—Ç–∞',
                savingBtn: '‚è≥ –ó–∞–ø–∞–∑–≤–∞–Ω–µ...',
                successMessage: '‚úÖ –ú–∞—Ä—à—Ä—É—Ç—ä—Ç –µ –∑–∞–ø–∞–∑–µ–Ω —É—Å–ø–µ—à–Ω–æ!',
                errorSaving: '–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞–ø–∞–∑–≤–∞–Ω–µ—Ç–æ –Ω–∞ –º–∞—Ä—à—Ä—É—Ç–∞. –û–ø–∏—Ç–∞–π—Ç–µ –æ—Ç–Ω–æ–≤–æ.',
                addManually: '‚ûï –î–æ–±–∞–≤–∏ "{query}" —Ä—ä—á–Ω–æ',
                addManuallyDesc: '–ö–ª–∏–∫–Ω–µ—Ç–µ, –∑–∞ –¥–∞ –¥–æ–±–∞–≤–∏—Ç–µ —Ç–æ–∑–∏ –≥—Ä–∞–¥ –∫—ä–º –º–∞—Ä—à—Ä—É—Ç–∞',
                ownCity: '–°–æ–±—Å—Ç–≤–µ–Ω –≥—Ä–∞–¥',
                unknownCountry: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞ —Å—Ç—Ä–∞–Ω–∞'
            },
            ro: {
                pageTitle: 'üó∫Ô∏è Ruta cƒÉlƒÉtoriei',
                pageDescription: 'AdƒÉuga»õi ora»ôe la ruta dvs. √Æn ordinea corectƒÉ',
                addStopLabel: 'AdaugƒÉ oprire:',
                addStopBtn: '‚ûï AdaugƒÉ oprire',
                cityPlaceholder: '√éncepe»õi sƒÉ tasta»õi numele ora»ôului...',
                stopsCount: 'Opriri',
                errorMessage: 'VƒÉ rugƒÉm sƒÉ adƒÉuga»õi cel pu»õin 2 opriri',
                exampleTitle: 'üí° Exemplu de rutƒÉ:',
                exampleText: 'Bucure»ôti ‚Üí Cluj-Napoca ‚Üí Timi»ôoara ‚Üí Constan»õa',
                confirmBtn: '‚úÖ ConfirmƒÉ ruta',
                savingBtn: '‚è≥ Se salveazƒÉ...',
                successMessage: '‚úÖ Ruta a fost salvatƒÉ cu succes!',
                errorSaving: 'Eroare la salvarea rutei. √éncerca»õi din nou.',
                addManually: '‚ûï AdaugƒÉ "{query}" manual',
                addManuallyDesc: 'Face»õi clic pentru a adƒÉuga acest ora»ô la rutƒÉ',
                ownCity: 'Ora»ô propriu',
                unknownCountry: '»öarƒÉ necunoscutƒÉ'
            },
            hu: {
                pageTitle: 'üó∫Ô∏è Utaz√°si √∫tvonal',
                pageDescription: 'Adja hozz√° a v√°rosokat az √∫tvonal√°hoz a helyes sorrendben',
                addStopLabel: 'Meg√°ll√≥ hozz√°ad√°sa:',
                addStopBtn: '‚ûï Meg√°ll√≥ hozz√°ad√°sa',
                cityPlaceholder: 'Kezdje el be√≠rni a v√°ros nev√©t...',
                stopsCount: 'Meg√°ll√≥k',
                errorMessage: 'K√©rj√ºk, adjon hozz√° legal√°bb 2 meg√°ll√≥t',
                exampleTitle: 'üí° √ötvonal p√©lda:',
                exampleText: 'Budapest ‚Üí Debrecen ‚Üí Szeged ‚Üí P√©cs',
                confirmBtn: '‚úÖ √ötvonal meger≈ës√≠t√©se',
                savingBtn: '‚è≥ Ment√©s...',
                successMessage: '‚úÖ Az √∫tvonal sikeresen elmentve!',
                errorSaving: 'Hiba az √∫tvonal ment√©sekor. Pr√≥b√°lja √∫jra.',
                addManually: '‚ûï "{query}" manu√°lis hozz√°ad√°sa',
                addManuallyDesc: 'Kattintson a v√°ros √∫tvonalhoz ad√°s√°hoz',
                ownCity: 'Saj√°t v√°ros',
                unknownCountry: 'Ismeretlen orsz√°g'
            },
            it: {
                pageTitle: 'üó∫Ô∏è Percorso di viaggio',
                pageDescription: 'Aggiungi le citt√† al tuo percorso nell\'ordine corretto',
                addStopLabel: 'Aggiungi fermata:',
                addStopBtn: '‚ûï Aggiungi fermata',
                cityPlaceholder: 'Inizia a digitare il nome della citt√†...',
                stopsCount: 'Fermate',
                errorMessage: 'Si prega di aggiungere almeno 2 fermate',
                exampleTitle: 'üí° Esempio di percorso:',
                exampleText: 'Roma ‚Üí Milano ‚Üí Napoli ‚Üí Firenze',
                confirmBtn: '‚úÖ Conferma percorso',
                savingBtn: '‚è≥ Salvataggio...',
                successMessage: '‚úÖ Percorso salvato con successo!',
                errorSaving: 'Errore nel salvare il percorso. Riprova.',
                addManually: '‚ûï Aggiungi "{query}" manualmente',
                addManuallyDesc: 'Clicca per aggiungere questa citt√† al percorso',
                ownCity: 'Citt√† personalizzata',
                unknownCountry: 'Paese sconosciuto'
            },
            es: {
                pageTitle: 'üó∫Ô∏è Ruta de viaje',
                pageDescription: 'A√±ade ciudades a tu ruta en el orden correcto',
                addStopLabel: 'A√±adir parada:',
                addStopBtn: '‚ûï A√±adir parada',
                cityPlaceholder: 'Empieza a escribir el nombre de la ciudad...',
                stopsCount: 'Paradas',
                errorMessage: 'Por favor, a√±ade al menos 2 paradas',
                exampleTitle: 'üí° Ejemplo de ruta:',
                exampleText: 'Madrid ‚Üí Barcelona ‚Üí Valencia ‚Üí Sevilla',
                confirmBtn: '‚úÖ Confirmar ruta',
                savingBtn: '‚è≥ Guardando...',
                successMessage: '‚úÖ ¬°Ruta guardada exitosamente!',
                errorSaving: 'Error al guardar la ruta. Int√©ntalo de nuevo.',
                addManually: '‚ûï A√±adir "{query}" manualmente',
                addManuallyDesc: 'Haz clic para a√±adir esta ciudad a la ruta',
                ownCity: 'Ciudad personalizada',
                unknownCountry: 'Pa√≠s desconocido'
            },
            ru: {
                pageTitle: 'üó∫Ô∏è –ú–∞—Ä—à—Ä—É—Ç –ø–æ–µ–∑–¥–∫–∏',
                pageDescription: '–î–æ–±–∞–≤—å—Ç–µ –≥–æ—Ä–æ–¥–∞ –≤–∞—à–µ–≥–æ –º–∞—Ä—à—Ä—É—Ç–∞ –≤ –ø—Ä–∞–≤–∏–ª—å–Ω–æ–º –ø–æ—Ä—è–¥–∫–µ',
                addStopLabel: '–î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É:',
                addStopBtn: '‚ûï –î–æ–±–∞–≤–∏—Ç—å –æ—Å—Ç–∞–Ω–æ–≤–∫—É',
                cityPlaceholder: '–ù–∞—á–Ω–∏—Ç–µ –≤–≤–æ–¥–∏—Ç—å –Ω–∞–∑–≤–∞–Ω–∏–µ –≥–æ—Ä–æ–¥–∞...',
                stopsCount: '–û—Å—Ç–∞–Ω–æ–≤–æ–∫',
                errorMessage: '–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –¥–æ–±–∞–≤—å—Ç–µ –º–∏–Ω–∏–º—É–º 2 –æ—Å—Ç–∞–Ω–æ–≤–∫–∏',
                exampleTitle: 'üí° –ü—Ä–∏–º–µ—Ä –º–∞—Ä—à—Ä—É—Ç–∞:',
                exampleText: '–ú–æ—Å–∫–≤–∞ ‚Üí –°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥ ‚Üí –ö–∞–∑–∞–Ω—å ‚Üí –ï–∫–∞—Ç–µ—Ä–∏–Ω–±—É—Ä–≥',
                confirmBtn: '‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç',
                savingBtn: '‚è≥ –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...',
                successMessage: '‚úÖ –ú–∞—Ä—à—Ä—É—Ç —É—Å–ø–µ—à–Ω–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω!',
                errorSaving: '–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏ –º–∞—Ä—à—Ä—É—Ç–∞. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.',
                addManually: '‚ûï –î–æ–±–∞–≤–∏—Ç—å "{query}" –≤—Ä—É—á–Ω—É—é',
                addManuallyDesc: '–ù–∞–∂–º–∏—Ç–µ, —á—Ç–æ–±—ã –¥–æ–±–∞–≤–∏—Ç—å —ç—Ç–æ—Ç –≥–æ—Ä–æ–¥ –∫ –º–∞—Ä—à—Ä—É—Ç—É',
                ownCity: '–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –≥–æ—Ä–æ–¥',
                unknownCountry: '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è —Å—Ç—Ä–∞–Ω–∞'
            }
        };
        
        const t = translations[userLang] || translations.uk;
        
        // –≠–ª–µ–º–µ–Ω—Ç—ã DOM
        const stopsContainer = document.getElementById('stopsContainer');
        const addStopContainer = document.getElementById('addStopContainer');
        const addStopBtn = document.getElementById('addStopBtn');
        const cityInput = document.getElementById('cityInput');
        const cityCount = document.getElementById('cityCount');
        const errorDiv = document.getElementById('error');
        const successDiv = document.getElementById('success');
        const submitBtn = document.getElementById('submitBtn');
        const form = document.getElementById('routeForm');
        
        // –ú–∞—Å—Å–∏–≤ –∑—É–ø–∏–Ω–æ–∫
        let stops = [];
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã
        function applyTranslations() {
            document.getElementById('pageTitle').textContent = t.pageTitle;
            document.getElementById('pageDescription').textContent = t.pageDescription;
            document.getElementById('addStopLabel').textContent = t.addStopLabel;
            addStopBtn.textContent = t.addStopBtn;
            cityInput.placeholder = t.cityPlaceholder;
            errorDiv.textContent = t.errorMessage;
            document.getElementById('exampleTitle').textContent = t.exampleTitle;
            document.getElementById('exampleText').textContent = t.exampleText;
            submitBtn.textContent = t.confirmBtn;
            document.getElementById('success').textContent = t.successMessage;
        }
        
        // –ü—Ä–æ—Å—Ç–∏–π –ø–æ—à—É–∫ –º—ñ—Å—Ç –±–µ–∑ –∑–æ–≤–Ω—ñ—à–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫
        let searchTimeout;
        let suggestionsContainer;
        
        function initCitySearch() {
            // –°—Ç–≤–æ—Ä—é—î–º–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –ø—ñ–¥–∫–∞–∑–æ–∫
            suggestionsContainer = document.createElement('div');
            suggestionsContainer.className = 'suggestions-container';
            suggestionsContainer.style.cssText = `
                position: absolute;
                top: 100%;
                left: 0;
                right: 0;
                background: var(--tg-theme-bg-color, #ffffff);
                border: 1px solid #e0e0e0;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
                z-index: 1000;
                max-height: 200px;
                overflow-y: auto;
                display: none;
            `;
            
            addStopContainer.style.position = 'relative';
            addStopContainer.appendChild(suggestionsContainer);
            
            // –û–±—Ä–æ–±–∫–∞ –≤–≤–µ–¥–µ–Ω–Ω—è
            cityInput.addEventListener('input', handleCityInput);
            cityInput.addEventListener('keydown', handleKeyDown);
            
            // –ó–∞–∫—Ä–∏—Ç—Ç—è –ø—ñ–¥–∫–∞–∑–æ–∫ –ø—Ä–∏ –∫–ª—ñ–∫—É –ø–æ–∑–∞ –Ω–∏–º–∏
            document.addEventListener('click', (e) => {
                if (!addStopContainer.contains(e.target)) {
                    hideSuggestions();
                }
            });
        }
        
        async function handleCityInput(e) {
            const query = e.target.value.trim();
            
            if (query.length < 2) {
                hideSuggestions();
                return;
            }
            
            // –û—á–∏—â—É—î–º–æ –ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π —Ç–∞–π–º–µ—Ä
            clearTimeout(searchTimeout);
            
            // –í—Å—Ç–∞–Ω–æ–≤–ª—é—î–º–æ –Ω–æ–≤–∏–π —Ç–∞–π–º–µ—Ä –¥–ª—è –∑–∞—Ç—Ä–∏–º–∫–∏ –∑–∞–ø–∏—Ç—É
            searchTimeout = setTimeout(async () => {
                await searchCities(query);
            }, 300);
        }
        
        async function searchCities(query) {
            try {
                console.log('Searching for:', query);
                let cities = [];
                
                // –°–ø—Ä–æ–±—É—î–º–æ –∫—ñ–ª—å–∫–∞ API –¥–ª—è –∫—Ä–∞—â–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                
                // 1. –°–ø–æ—á–∞—Ç–∫—É —Å–ø—Ä–æ–±—É—î–º–æ GeoNames API (–±–µ–∑–∫–æ—à—Ç–æ–≤–Ω–∏–π)
                try {
                    const geoNamesUrl = `https://secure.geonames.org/searchJSON?q=${encodeURIComponent(query)}&maxRows=8&featureClass=P&username=demo&lang=${userLang}`;
                    console.log('GeoNames URL:', geoNamesUrl);
                    
                    const geoResponse = await fetch(geoNamesUrl);
                    const geoData = await geoResponse.json();
                    
                    if (geoData.geonames && geoData.geonames.length > 0) {
                        cities = geoData.geonames.map(item => ({
                            name: item.name,
                            country: item.countryName || '–ù–µ–≤—ñ–¥–æ–º–∞ –∫—Ä–∞—ó–Ω–∞',
                            full_name: `${item.name}, ${item.adminName1 || ''}, ${item.countryName || ''}`,
                            lat: item.lat,
                            lon: item.lng,
                            source: 'geonames'
                        }));
                        console.log('GeoNames results:', cities);
                    }
                } catch (geoError) {
                    console.log('GeoNames failed:', geoError);
                }
                
                // 2. –Ø–∫—â–æ GeoNames –Ω–µ –¥–∞–≤ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤, —Å–ø—Ä–æ–±—É—î–º–æ Nominatim (–±—ñ–ª—å—à –º'—è–∫–∏–π —Ñ—ñ–ª—å—Ç—Ä)
                if (cities.length === 0) {
                    try {
                        const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(query)}&limit=10&addressdetails=1&accept-language=${userLang}`;
                        console.log('Nominatim URL:', nominatimUrl);
                        
                        const nomResponse = await fetch(nominatimUrl);
                        const nomData = await nomResponse.json();
                        
                        // –ú'—è–∫—à–∏–π —Ñ—ñ–ª—å—Ç—Ä - –ø—Ä–∏–π–º–∞—î–º–æ –±—ñ–ª—å—à–µ —Ç–∏–ø—ñ–≤ –º—ñ—Å—Ü—å
                        cities = nomData
                            .filter(item => {
                                const type = item.type;
                                const category = item.category;
                                const cls = item.class;
                                
                                // –ü—Ä–∏–π–º–∞—î–º–æ –±—ñ–ª—å—à–µ –≤–∞—Ä—ñ–∞–Ω—Ç—ñ–≤
                                return (
                                    type === 'city' || type === 'town' || type === 'village' || 
                                    type === 'hamlet' || type === 'municipality' || type === 'suburb' ||
                                    category === 'place' || cls === 'place' || cls === 'boundary'
                                );
                            })
                            .slice(0, 8) // –û–±–º–µ–∂—É—î–º–æ –¥–æ 8 —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤
                            .map(item => {
                                const nameParts = item.display_name.split(',');
                                return {
                                    name: nameParts[0].trim(),
                                    country: nameParts[nameParts.length - 1].trim(),
                                    full_name: item.display_name,
                                    lat: item.lat,
                                    lon: item.lon,
                                    source: 'nominatim'
                                };
                            });
                        
                        console.log('Nominatim results:', cities);
                    } catch (nomError) {
                        console.log('Nominatim failed:', nomError);
                    }
                }
                
                // 3. –Ø–∫—â–æ —ñ Nominatim –Ω–µ –¥–æ–ø–æ–º—ñ–≥, —Å–ø—Ä–æ–±—É—î–º–æ REST Countries API –¥–ª—è –∫—Ä–∞—ó–Ω
                if (cities.length === 0 && query.length > 2) {
                    try {
                        const countriesUrl = `https://restcountries.com/v3.1/name/${encodeURIComponent(query)}?fields=name,capital`;
                        console.log('REST Countries URL:', countriesUrl);
                        
                        const countryResponse = await fetch(countriesUrl);
                        const countryData = await countryResponse.json();
                        
                        if (Array.isArray(countryData)) {
                            cities = countryData.map(country => ({
                                name: Array.isArray(country.capital) ? country.capital[0] : country.capital,
                                country: country.name.common,
                                full_name: `${country.capital} (—Å—Ç–æ–ª–∏—Ü—è ${country.name.common})`,
                                lat: null,
                                lon: null,
                                source: 'countries'
                            })).filter(city => city.name); // –§—ñ–ª—å—Ç—Ä—É—î–º–æ —Ç—ñ–ª—å–∫–∏ –∑ –Ω–∞–∑–≤–∞–º–∏
                            
                            console.log('Countries API results:', cities);
                        }
                    } catch (countryError) {
                        console.log('Countries API failed:', countryError);
                    }
                }
                
                // –í–∏–¥–∞–ª—è—î–º–æ –¥—É–±–ª—ñ–∫–∞—Ç–∏ –ø–æ –Ω–∞–∑–≤—ñ
                const uniqueCities = cities.filter((city, index, self) => 
                    index === self.findIndex(c => 
                        c.name.toLowerCase() === city.name.toLowerCase()
                    )
                );
                
                console.log('Final unique cities:', uniqueCities);
                showSuggestions(uniqueCities, query);
                
            } catch (error) {
                console.error('Error in searchCities:', error);
                showSuggestions([], query);
            }
        }
        
        function showSuggestions(cities, query) {
            suggestionsContainer.innerHTML = '';
            
            if (cities.length === 0) {
                // –ü–æ–∫–∞–∑—É—î–º–æ –æ–ø—Ü—ñ—é –¥–æ–¥–∞—Ç–∏ –º—ñ—Å—Ç–æ –≤—Ä—É—á–Ω—É
                const manualOption = document.createElement('div');
                manualOption.className = 'suggestion-item manual-add';
                manualOption.style.cssText = `
                    padding: 12px 15px;
                    cursor: pointer;
                    border-bottom: 1px solid #f0f0f0;
                    background: #f8f9fa;
                `;
                manualOption.innerHTML = `
                    <div style="font-weight: 600; color: var(--tg-theme-button-color, #0088cc);">
                        ‚ûï –î–æ–¥–∞—Ç–∏ "${query}" –≤—Ä—É—á–Ω—É
                    </div>
                    <div style="font-size: 12px; color: #666;">
                        –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å, —â–æ–± –¥–æ–¥–∞—Ç–∏ —Ü–µ –º—ñ—Å—Ç–æ –¥–æ –º–∞—Ä—à—Ä—É—Ç—É
                    </div>
                `;
                manualOption.addEventListener('click', () => {
                    addStop(query, '–ù–µ–≤—ñ–¥–æ–º–∞ –∫—Ä–∞—ó–Ω–∞');
                    cityInput.value = '';
                    hideAddStopInput();
                });
                suggestionsContainer.appendChild(manualOption);
            } else {
                // –ü–æ–∫–∞–∑—É—î–º–æ –∑–Ω–∞–π–¥–µ–Ω—ñ –º—ñ—Å—Ç–∞
                cities.forEach(city => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.style.cssText = `
                        padding: 12px 15px;
                        cursor: pointer;
                        border-bottom: 1px solid #f0f0f0;
                    `;
                                         item.innerHTML = `
                         <div style="font-weight: 600;">${city.name}</div>
                         <div style="font-size: 12px; color: #666;">
                             ${city.country}
                             ${city.source ? `<span style="opacity: 0.7; margin-left: 8px;">(${city.source})</span>` : ''}
                         </div>
                     `;
                    
                    item.addEventListener('click', () => {
                        addStop(city.name, city.country);
                        cityInput.value = '';
                        hideAddStopInput();
                    });
                    
                    item.addEventListener('mouseenter', () => {
                        item.style.background = 'var(--tg-theme-button-color, #0088cc)';
                        item.style.color = 'white';
                    });
                    
                    item.addEventListener('mouseleave', () => {
                        item.style.background = '';
                        item.style.color = '';
                    });
                    
                    suggestionsContainer.appendChild(item);
                });
                
                // –î–æ–¥–∞—î–º–æ –æ–ø—Ü—ñ—é —Ä—É—á–Ω–æ–≥–æ –≤–≤–µ–¥–µ–Ω–Ω—è –≤ –∫—ñ–Ω—Ü—ñ
                const manualOption = document.createElement('div');
                manualOption.className = 'suggestion-item manual-add';
                manualOption.style.cssText = `
                    padding: 12px 15px;
                    cursor: pointer;
                    background: #f8f9fa;
                    border-top: 1px solid #e0e0e0;
                `;
                manualOption.innerHTML = `
                    <div style="font-weight: 600; color: var(--tg-theme-button-color, #0088cc);">
                        ‚ûï –î–æ–¥–∞—Ç–∏ "${query}" –≤—Ä—É—á–Ω—É
                    </div>
                `;
                manualOption.addEventListener('click', () => {
                    addStop(query, '–í–ª–∞—Å–Ω–µ –º—ñ—Å—Ç–æ');
                    cityInput.value = '';
                    hideAddStopInput();
                });
                suggestionsContainer.appendChild(manualOption);
            }
            
            suggestionsContainer.style.display = 'block';
        }
        
        function hideSuggestions() {
            if (suggestionsContainer) {
                suggestionsContainer.style.display = 'none';
            }
        }
        
        function handleKeyDown(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                const query = cityInput.value.trim();
                if (query) {
                    // –î–æ–¥–∞—î–º–æ –º—ñ—Å—Ç–æ –≤—Ä—É—á–Ω—É –ø—Ä–∏ –Ω–∞—Ç–∏—Å–∫–∞–Ω–Ω—ñ Enter
                    addStop(query, '–í–ª–∞—Å–Ω–µ –º—ñ—Å—Ç–æ');
                    cityInput.value = '';
                    hideAddStopInput();
                }
            } else if (e.key === 'Escape') {
                hideAddStopInput();
            }
        }
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑—É–ø–∏–Ω–∫–∏
        function addStop(name, country) {
            const stop = { name, country };
            stops.push(stop);
            renderStops();
            updateUI();
        }
        
        // –£–¥–∞–ª–µ–Ω–∏–µ –∑—É–ø–∏–Ω–∫–∏
        function removeStop(index) {
            stops.splice(index, 1);
            renderStops();
            updateUI();
        }
        
        // –û—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –∑—É–ø–∏–Ω–æ–∫
        function renderStops() {
            stopsContainer.innerHTML = '';
            
            stops.forEach((stop, index) => {
                const stopElement = document.createElement('div');
                stopElement.className = 'stop-item';
                stopElement.innerHTML = `
                    <div class="stop-number">${index + 1}</div>
                    <div class="stop-content">
                        <div class="stop-name">${stop.name}</div>
                        <div class="stop-country">${stop.country}</div>
                    </div>
                    <button type="button" class="remove-stop" onclick="removeStop(${index})">√ó</button>
                `;
                stopsContainer.appendChild(stopElement);
            });
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function showAddStopInput() {
            addStopContainer.style.display = 'block';
            addStopBtn.style.display = 'none';
            cityInput.focus();
        }
        
        // –°–∫—Ä—ã—Ç—å –ø–æ–ª–µ –≤–≤–æ–¥–∞
        function hideAddStopInput() {
            addStopContainer.style.display = 'none';
            addStopBtn.style.display = 'block';
        }
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ UI
        function updateUI() {
            cityCount.textContent = `${t.stopsCount}: ${stops.length}`;
            
            if (stops.length < 2) {
                errorDiv.style.display = 'block';
                submitBtn.disabled = true;
            } else {
                errorDiv.style.display = 'none';
                submitBtn.disabled = false;
            }
        }
        
        // –°–æ–±—ã—Ç–∏—è
        addStopBtn.addEventListener('click', showAddStopInput);
        
        cityInput.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                hideAddStopInput();
            }
        });
        
        // –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ—Ä–º—ã
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            if (stops.length < 2) {
                errorDiv.style.display = 'block';
                return;
            }
            
            submitBtn.disabled = true;
            submitBtn.textContent = t.savingBtn;
            
            try {
                const cities = stops.map(stop => stop.name);
                const citiesString = cities.join(', ');
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —á–µ—Ä–µ–∑ Telegram WebApp
                tg.sendData(JSON.stringify({
                    action: 'cities_selected',
                    cities: cities,
                    cities_string: citiesString,
                    stops: stops
                }));
                
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤–µ–±—Ö—É–∫ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
                console.log('Sending webhook to:', webhookUrl);
                try {
                    const response = await fetch(webhookUrl, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            user_id: userId,
                            action: 'cities_selected',
                            cities: cities,
                            cities_string: citiesString,
                            stops: stops,
                            timestamp: new Date().toISOString()
                        })
                    });
                    
                    if (response.ok) {
                        console.log('Webhook sent successfully');
                    } else {
                        console.log('Webhook failed with status:', response.status);
                    }
                } catch (webhookError) {
                    console.log('Webhook error:', webhookError);
                }
                
                successDiv.style.display = 'block';
                
                // –ó–∞–∫—Ä—ã–≤–∞–µ–º WebApp —á–µ—Ä–µ–∑ 1 —Å–µ–∫—É–Ω–¥—É
                setTimeout(() => {
                    tg.close();
                }, 1000);
                
            } catch (error) {
                alert(t.errorSaving);
                submitBtn.disabled = false;
                submitBtn.textContent = t.confirmBtn;
            }
        });
        
        // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏ –¥–ª—è –∫–Ω–æ–ø–æ–∫
        window.removeStop = removeStop;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
        applyTranslations();
        initCitySearch();
        updateUI();
        
        // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–Ω–æ–ø–∫–∏ Telegram WebApp
        tg.MainButton.text = t.confirmBtn;
        tg.MainButton.show();
        
        tg.MainButton.onClick(() => {
            form.dispatchEvent(new Event('submit'));
        });
        
        }); // –ó–∞–∫—Ä–∏–≤–∞—î–º–æ DOMContentLoaded
    </script>
</body>
</html>